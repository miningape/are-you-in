let AppConfig = struct {
    port: int,
    auth0: {
        accessKey: string
    }
};

let config = file('config.yaml').map(File::yaml<AppConfig>());

let injector = Injector();

injector.Register(TokenValidator) Auth0TokenValidator {
    access_key: config.auth0.accessKey,
};

@injector.Inject 
let validateToken = 
    (validator: TokenValidator) =>
        (token: string | null) => 
            token == null ? false : validator.isValid(token)

let app = Server {
    port: config.port
};

Register(app) 
    Route('/') () => "Hello, World!"

app
    .register(
        Before(enrichUser) Pipe('/*') (request) =>
            match (
                match request.headers.authorization on
                    | 'Bearer {token}' |> token
                    | _ |> null)
                    |> validateToken.inject()
            on 
                | true |> Ok(request)
                | Error(_) |> AuthenticationError
    )
    .register(Route('/') () => "Hello, World!");
    

config
    .map(
        () => app.start()
            .then(=>log("started"))
            .catch(reportToSentry)
    )
    .else(() => throw Error('No config'));

table User {
    [@id: uuid];

    name: string;
    age: integer;

    last_online: DateTime?;
    number_logins: integer;

    tickets: Ticket[];
};

create {
    table Ticket {
        @id: uuid;

        reporter: User;
    };
};


update {
    new_user = new User {
        name: 'Kyle',
        age: 22,
        last_online: null,
        number_logins: 0
    };

    push Ticket {
        reporter: connect new_user
    };      
};



function UserTickets() {
    User join Ticket
};

api /dump UserTickets;
